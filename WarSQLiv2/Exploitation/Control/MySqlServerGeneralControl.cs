using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using MySql.Data.MySqlClient;

namespace WarSQLiv2.Exploitation.Control
{
    class MySqlServerGeneralControl
    {
        private string _exception;
        private string _exploitResult;
        private string _exploitCode;
        private string _currentDb;

        public string CurrentDb
        {
            get { return _currentDb; }
        }
        public string Exception
        {
            get { return _exception; }
            set
            {
                _exception = string.Empty;
                _exception = value;
            }
        }
        public string ExploitResult
        {
            get { return _exploitResult; }
        }
        public string SelectedItem { get; set; }

        public List<string> LootedList { get; set; }
        private void LootedControl()
        {
            var lootedFileControl = new LootedFileControl();
            try
            {
                lootedFileControl.FileControl();
                var lootedList = lootedFileControl.LootedList;
                foreach (var t in lootedList)
                {
                    LootedList.Add(t);
                }
            }
            catch (Exception exp)
            {
                Exception = lootedFileControl.Exception;
            }
        }
        private void GetDatabaseControl()
        {
            LootedControl();
            var changeLang = new LanguageControl();
            changeLang.FindLang();
            if (!string.IsNullOrEmpty(SelectedItem))
            {
                var split = SelectedItem.Split(':');
                var server = split[0];
                var user = split[2];
                var pass = split[3];
                var con = new MySqlConnectionStringBuilder() { Server = server, UserID = user, Password = pass };
                var mysqlConn = new MySqlConnection(con.ToString());
                try
                {
                    var cmd = new MySqlCommand(_exploitCode, mysqlConn);
                    mysqlConn.Open();
                    var rdr = cmd.ExecuteReader();
                    _exploitResult = string.Empty;
                    while (rdr.Read())
                    {
                        _exploitResult += $"{Environment.NewLine}{rdr[0]}";
                    }
                    rdr.Close();
                    mysqlConn.Close();
                }
                catch (SqlException exp)
                {
                    Exception = string.Format("{2}{3}{0}{1}", Environment.NewLine, exp.Message, changeLang.SelectedLanguage.GetString("GeneralError1"), changeLang.SelectedLanguage.GetString("GeneralError2"));
                }
            }
            else
            {
                Exception = $"{Environment.NewLine}{changeLang.SelectedLanguage.GetString("MessageExploitError1")}";
            }
        }
        public void GetCurrentDb()
        {
            _exploitCode = string.Empty;
            _exploitCode = "show databases";
            GetDatabaseControl();
            _currentDb = _exploitResult;
        }
    }
}
